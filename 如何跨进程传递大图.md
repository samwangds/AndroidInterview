é¢è¯•å®˜æäº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ ğŸ˜ã€ğŸ˜¨ å’Œ ğŸ¤”ï¸ ä¸‰ä½åŒå­¦çš„è¡¨ç°å¦‚ä½•å§

---

>ğŸ˜ è‡ªè®¤ä¸ºæ— æ‰€ä¸çŸ¥ï¼Œæ°´å¹³å·²è¾¾åº”ç”¨å¼€å‘å¤©èŠ±æ¿ï¼Œç›®å‰æœˆè–ª 10k

**é¢è¯•å®˜**ï¼šå¦‚ä½•è·¨è¿›ç¨‹ä¼ é€’å¤§å›¾

ğŸ˜ï¼šå¾ˆç®€å•ï¼ŒæŠŠå›¾ç‰‡å­˜åˆ° SD å¡ï¼Œç„¶åæŠŠè·¯å¾„ä¼ è¿‡å»ï¼Œåœ¨åˆ«çš„è¿›ç¨‹è¯»å‡ºæ¥è¿™ä¸å°±å®Œäº‹äº†å˜›ã€‚

**é¢è¯•å®˜**ï¼šè¿™ä¸ªéœ€è¦æ–‡ä»¶æ“ä½œï¼Œæ•ˆç‡ä¸è¡Œï¼Œæœ‰åˆ«çš„æ–¹æ³•å—ï¼Ÿ

ğŸ˜ï¼šBitmap å®ç°äº† Parcelable æ¥å£ï¼Œå¯ä»¥é€šè¿‡ Intent.putExtra(String name, Parcelable value) æ–¹æ³•ç›´æ¥æ”¾ Intent é‡Œé¢ä¼ é€’ã€‚

**é¢è¯•å®˜**ï¼šé‚£è¿™ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆç¼ºç‚¹ï¼Ÿ

ğŸ˜ï¼šBitmap å¤ªå¤§å°±ä¼šæŠ›å¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘æ›´å–œæ¬¢ä¼ è·¯å¾„

**é¢è¯•å®˜**ï¼šä¸ºä»€ä¹ˆä¼šæŠ›å¼‚å¸¸ï¼Ÿ

ğŸ˜ï¼š.....

**é¢è¯•å®˜**ï¼šå¥½çš„ï¼Œå›å»ç­‰é€šçŸ¥å§



---

>ğŸ˜¨ ä¸šä½™æ—¶é—´ç»å¸¸æ‰“æ¸¸æˆã€è¿½å‰§ã€ç†¬å¤œï¼Œç›®å‰æœˆè–ª 15k

**é¢è¯•å®˜**ï¼šIntent ç›´æ¥ä¼  Bitmap ä¼šæœ‰ä»€ä¹ˆé—®é¢˜?

ğŸ˜¨ï¼šBitmap å¤ªå¤§ä¼šæŠ› TransactionTooLargeException å¼‚å¸¸ï¼ŒåŸå› æ˜¯ï¼šåº•å±‚åˆ¤æ–­åªè¦ Binder Transaction å¤±è´¥ï¼Œä¸” Intent çš„æ•°æ®å¤§äº 200k å°±ä¼šæŠ›è¿™ä¸ªå¼‚å¸¸äº†ã€‚ï¼ˆè§ï¼šandroid_util_Binder.cpp æ–‡ä»¶ signalExceptionForError æ–¹æ³•ï¼‰

**é¢è¯•å®˜**ï¼šä¸ºä»€ä¹ˆ Intent ä¼ å€¼ä¼šæœ‰å¤§å°é™åˆ¶ã€‚

ğŸ˜¨ï¼šåº”ç”¨è¿›ç¨‹åœ¨å¯åŠ¨ Binder æœºåˆ¶æ—¶ä¼šæ˜ å°„ä¸€å— 1M å¤§å°çš„å†…å­˜ï¼Œæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ Binder äº‹åŠ¡å…±äº«è¿™ 1M çš„ç¼“å†²åŒº	ã€‚å½“ä½¿ç”¨ Intent è¿›è¡Œ IPC æ—¶ç”³è¯·çš„ç¼“å­˜è¶…è¿‡ 1M - å…¶ä»–äº‹åŠ¡å ç”¨çš„å†…å­˜æ—¶ï¼Œå°±ä¼šç”³è¯·å¤±è´¥æŠ› TransactionTooLargeException å¼‚å¸¸äº†ã€‚ ï¼ˆå“¼ï¼Œä¸ä¼šåƒä¸Šæ¬¡ä¸€æ ·ç­”ä¸å‡ºæ¥äº†ã€‚è§ï¼šâ€œè°ˆè°ˆä½ å¯¹ binder çš„ç†è§£ï¼Ÿè¿™æ ·å›ç­”æ‰è¿‡å…³â€ï¼‰

**é¢è¯•å®˜**ï¼šå¦‚ä½•ç»•å¼€è¿™ä¸ªé™åˆ¶å‘¢ï¼Ÿ

ğŸ˜¨ï¼šé€šè¿‡ AIDL ä½¿ç”¨ Binder è¿›è¡Œ IPC å°±ä¸å—è¿™ä¸ªé™åˆ¶ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
Bundle bundle = new Bundle();
bundle.putBinder("binder", new IRemoteGetBitmap.Stub() {
    @Override
    public Bitmap getBitMap() throws RemoteException {
        return mBitmap;
    }
});
intent.putExtras(bundle);
```

**é¢è¯•å®˜**ï¼šè¿™æ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ

ğŸ˜¨ï¼šè¿˜æ²¡å»ç»†çœ‹

**é¢è¯•å®˜**ï¼šå¥½çš„ï¼Œå›å»ç­‰é€šçŸ¥å§

---

>ğŸ¤”ï¸ åšæŒæ¯å¤©å­¦ä¹ ã€ä¸æ–­çš„æå‡è‡ªå·±ï¼Œç›®å‰æœˆè–ª 30k

**é¢è¯•å®˜**ï¼šä¸ºä»€ä¹ˆé€šè¿‡ putBinder çš„æ–¹å¼ä¼  Bitmap ä¸ä¼šæŠ› TransactionTooLargeException å¼‚å¸¸

ğŸ¤”ï¸ï¼šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ï¼Œåº•å±‚åœ¨ IPC æ—¶æ˜¯æ€ä¹ˆæŠŠ Bitmap å†™è¿› Parcel çš„ã€‚

```c++
Android - 28 Bitmap.cpp
static jboolean Bitmap_writeToParcel(JNIEnv* env, jobject, ...) {
    // æ‹¿åˆ° Native çš„ Bitmap                                
    auto bitmapWrapper = reinterpret_cast<BitmapWrapper*>(bitmapHandle);
    // æ‹¿åˆ°å…¶å¯¹åº”çš„ SkBitmap, ç”¨äºè·å– Bitmap çš„åƒç´ ä¿¡æ¯
    bitmapWrapper->getSkBitmap(&bitmap);

    int fd = bitmapWrapper->bitmap().getAshmemFd();
    if (fd >= 0 && !isMutable && p->allowFds()) {
   	 		// Bitmap å¸¦äº† ashmemFd && Bitmap ä¸å¯ä¿®æ”¹ && Parcel å…è®¸å¸¦ fd
    		// å°±ç›´æ¥æŠŠ FD å†™åˆ° Parcel é‡Œï¼Œç»“æŸã€‚
        status = p->writeDupImmutableBlobFileDescriptor(fd);
        return JNI_TRUE;
    }

    // ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶å°±è¦æŠŠ Bitmap æ‹·è´åˆ°ä¸€å—æ–°çš„ç¼“å†²åŒº
    android::Parcel::WritableBlob blob;
  	// é€šè¿‡ writeBlob æ‹¿åˆ°ä¸€å—ç¼“å†²åŒº blob
    status = p->writeBlob(size, mutableCopy, &blob);

    // è·å–åƒç´ ä¿¡æ¯å¹¶å†™åˆ°ç¼“å†²åŒº
    const void* pSrc =  bitmap.getPixels();
    if (pSrc == NULL) {
        memset(blob.data(), 0, size);
    } else {
        memcpy(blob.data(), pSrc, size);
    }
}
```

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ writeBlob æ˜¯æ€ä¹ˆè·å–ç¼“å†²åŒºçš„ï¼ˆæ³¨æ„è™½ç„¶æ–¹æ³•åå†™ç€ write , ä½†æ˜¯å®é™…å¾€ç¼“å†²åŒºå†™æ•°æ®æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•æ‰§è¡Œä¹‹åï¼‰

```c++
Android - 28 Parcel.cpp
// Maximum size of a blob to transfer in-place.
static const size_t BLOB_INPLACE_LIMIT = 16 * 1024;

status_t Parcel::writeBlob(size_t len, bool mutableCopy, WritableBlob* outBlob)
{
    if (!mAllowFds || len <= BLOB_INPLACE_LIMIT) {
    // å¦‚æœä¸å…è®¸å¸¦ fd ï¼Œæˆ–è€…è¿™ä¸ªæ•°æ®å°äº 16K
    // å°±ç›´æ¥åœ¨ Parcel çš„ç¼“å†²åŒºé‡Œåˆ†é…ä¸€å—ç©ºé—´æ¥ä¿å­˜è¿™ä¸ªæ•°æ®
        status = writeInt32(BLOB_INPLACE);
        void* ptr = writeInplace(len);
        outBlob->init(-1, ptr, len, false);
        return NO_ERROR;
    }

		// å¦å¤–å¼€è¾Ÿä¸€ä¸ª ashmemï¼Œæ˜ å°„å‡ºä¸€å—å†…å­˜ï¼Œåç»­æ•°æ®å°†ä¿å­˜åœ¨ ashmem çš„å†…å­˜é‡Œ
    int fd = ashmem_create_region("Parcel Blob", len);
    void* ptr = ::mmap(NULL, len, PROT_READ | PROT_WRITE, MAP_SHARED, fd, 0);
    ...
  	// parcel é‡Œåªå†™ä¸ª fd å°±å¥½äº†ï¼Œè¿™æ ·å°±ç®—æ•°æ®é‡å¾ˆå¤§ï¼Œparcel è‡ªå·±çš„ç¼“å†²åŒºä¹Ÿä¸ç”¨å¾ˆå¤§
    status = writeFileDescriptor(fd, true /*takeOwnership*/);
 		outBlob->init(fd, ptr, len, mutableCopy);
    return status;
}
```

é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼ŒåŒä¸€ä¸ª Bitmap å†™å…¥åˆ° Parcel æ‰€å çš„ç¼“å†²åŒºå¤§å°å’Œ Pacel çš„ allowFds æœ‰å…³ã€‚

ç›´æ¥é€šè¿‡ Intent ä¼  Bitmap å®¹æ˜“æŠ› TransactionTooLargeException å¼‚å¸¸ï¼Œå°±æ˜¯å› ä¸º Parcel çš„ allowFds = falseï¼Œç›´æ¥æŠŠ Bitmap å†™å…¥ç¼“å†²åŒºå ç”¨äº†è¾ƒå¤§çš„å†…å­˜ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒallowFds æ˜¯ä»€ä¹ˆæ—¶å€™è¢«è®¾ç½®æˆ false çš„å‘¢ï¼š

```JAVA
// å¯åŠ¨ Activity æ‰§è¡Œåˆ° Instrumentation.java çš„è¿™ä¸ªæ–¹æ³•
public ActivityResult execStartActivity(..., Intent intent, ...){
  ...
  intent.prepareToLeaveProcess(who);
	ActivityManager.getService().startActivity(...,intent,...)
}

// Intent.java
public void prepareToLeaveProcess(boolean leavingPackage) {
 // è¿™è¾¹ä¸€å±‚å±‚ä¼ é€’åˆ°æœ€åè®¾ç½® Parcel çš„ allowfds
  setAllowFds(false);
  ....
}
```

**é¢è¯•å®˜**ï¼šå¤ªå¤šäº†ï¼Œä½ æ‡‚çš„ã€‚

ğŸ¤”ï¸ï¼šæ€»ç»“ä¸€ä¸‹ï¼šè¾ƒå¤§çš„ bitmap ç›´æ¥é€šè¿‡ Intent ä¼ é€’å®¹æ˜“æŠ›å¼‚å¸¸æ˜¯å› ä¸º Intent å¯åŠ¨ç»„ä»¶æ—¶ï¼Œç³»ç»Ÿç¦æ‰äº†æ–‡ä»¶æè¿°ç¬¦ fd æœºåˆ¶ , bitmap æ— æ³•åˆ©ç”¨å…±äº«å†…å­˜ï¼Œåªèƒ½æ‹·è´åˆ° Binder æ˜ å°„çš„ç¼“å†²åŒºï¼Œå¯¼è‡´ç¼“å†²åŒºè¶…é™, è§¦å‘å¼‚å¸¸; è€Œé€šè¿‡ putBinder çš„æ–¹å¼ï¼Œé¿å…äº† Intent ç¦ç”¨æè¿°ç¬¦çš„å½±å“ï¼Œbitmap å†™ parcel æ—¶çš„ allowFds é»˜è®¤æ˜¯ true , å¯ä»¥åˆ©ç”¨å…±äº«å†…å­˜ï¼Œæ‰€ä»¥èƒ½é«˜æ•ˆä¼ è¾“å›¾ç‰‡ã€‚

**é¢è¯•å®˜**ï¼šå¯ä»¥ï¼Œæˆ‘ä»¬å†æ¥èŠèŠåˆ«çš„ã€‚